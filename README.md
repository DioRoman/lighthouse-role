# Документация Ansible Playbook для развертывания Lighthouse с Nginx

## Описание

Этот Ansible playbook выполняет установку и настройку Lighthouse - инструмента для визуализации метрик, работающего совместно с веб-сервером Nginx.

## Задачи

### 1. Установка необходимых пакетов
Устанавливает требуемые для работы пакеты:
- `nginx` - веб-сервер
- `unzip` - утилита для распаковки архивов
- `curl` - утилита для загрузки файлов

Параметры:
- `update_cache: true` - обновляет кеш пакетов перед установкой
- Использует `loop` для итерации по списку пакетов

### 2. Остановка сервиса Nginx
Останавливает сервис Nginx перед внесением изменений в конфигурацию.

### 3. Загрузка Lighthouse
Загружает последнюю версию Lighthouse из репозитория GitHub:
- Скачивает ZIP-архив по URL `https://github.com/VKCOM/lighthouse/archive/refs/heads/master.zip`
- Сохраняет в `/tmp/lighthouse.zip`
- Устанавливает права `0755` на скачанный файл

### 4. Создание целевой директории
Создает директорию `/var/www/lighthouse` для размещения файлов Lighthouse:
- Устанавливает права `0755`
- Владельца и группу `root:root`

### 5. Распаковка Lighthouse
Распаковывает архив Lighthouse:
- Источник: `/tmp/lighthouse.zip`
- Назначение: `/var/www/lighthouse`
- `remote_src: true` - указывает, что архив находится на управляемом узле
- `extra_opts: ["-o"]` - дополнительные опции для unzip

### 6. Установка прав доступа
Рекурсивно устанавливает права на все файлы и директории в `/var/www/lighthouse`:
- Права `0755`
- Владельца и группу `root:root`

### 7. Настройка конфигурации Nginx
Настраивает конфигурацию Nginx для работы с Lighthouse:
- Использует шаблон `lighthouse.conf.j2`
- Сохраняет конфигурацию в `/etc/nginx/sites-available/lighthouse`
- Устанавливает права `0644`
- Владельца и группу `root:root`

### 8. Активация сайта Lighthouse
Создает символическую ссылку для активации конфигурации Lighthouse:
- Ссылка из `/etc/nginx/sites-available/lighthouse` в `/etc/nginx/sites-enabled/lighthouse`

### 9. Отключение сайта по умолчанию
Удаляет конфигурацию сайта по умолчанию:
- Удаляет файл `/etc/nginx/sites-enabled/default`

### 10. Запуск сервиса Nginx
Запускает и включает в автозагрузку сервис Nginx:
- `state: started` - запускает сервис
- `enabled: true` - включает автозагрузку при старте системы

## Требования

- Ansible 2.9+
- Ubuntu/Debian система (playbook использует модули apt)
- Доступ в интернет для загрузки Lighthouse и пакетов
- Права root/sudo для выполнения задач

## Использование

1. Подготовьте шаблон конфигурации Nginx `lighthouse.conf.j2`
2. Выполните playbook:
   ```bash
   ansible-playbook deploy_lighthouse.yml
   ```

## Примечания

- Playbook разработан для Debian-based систем
- Для работы требуется предварительно подготовленный шаблон конфигурации Nginx
- Lighthouse будет доступен по адресу, указанному в конфигурации Nginx
- После выполнения playbook веб-интерфейс Lighthouse должен быть доступен через браузер
